name: GitHub Stats Cards
permissions:
  contents: write
on:
  schedule:
    - cron: "0 0 * * *" # هر روز نیمه شب UTC اجرا میشه
  workflow_dispatch:     # امکان اجرا دستی

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: Install dependencies
        run: pip install requests matplotlib cairosvg

      - name: Generate Stats Cards
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          python << 'EOF'
          import os, requests
          from collections import defaultdict
          import matplotlib.pyplot as plt

          USERNAME = "arminkhorami"
          TOKEN = os.environ["GH_TOKEN"]
          headers = {"Authorization": f"token {TOKEN}"}

          # ---------- جمع آوری داده ----------
          repos_url = "https://api.github.com/user/repos?per_page=100&type=all"
          language_totals = defaultdict(int)
          total_repos = 0
          total_stars = 0

          while repos_url:
              r = requests.get(repos_url, headers=headers)
              repos = r.json()
              total_repos += len(repos)
              for repo in repos:
                  total_stars += repo.get("stargazers_count",0)
                  langs = requests.get(repo["languages_url"], headers=headers).json()
                  for lang, size in langs.items():
                      language_totals[lang] += size
              repos_url = r.links.get("next", {}).get("url")

          # ---------- کارت آمار کل ----------
          stats_svg = f"""<svg width="400" height="120" xmlns="http://www.w3.org/2000/svg">
          <rect width="400" height="120" fill="#0d1117" rx="10"/>
          <text x="20" y="40" fill="#fff" font-size="20">GitHub Stats for {USERNAME}</text>
          <text x="20" y="70" fill="#c9d1d9" font-size="16">Total Repos: {total_repos}</text>
          <text x="20" y="95" fill="#c9d1d9" font-size="16">Total Stars: {total_stars}</text>
          </svg>"""
          with open("github_stats.svg","w") as f:
              f.write(stats_svg)

          # ---------- Top 6 زبان + Other ----------
          sorted_langs = sorted(language_totals.items(), key=lambda x: x[1], reverse=True)
          top_langs = sorted_langs[:6]
          other_bytes = sum(size for _, size in sorted_langs[6:])
          if other_bytes > 0:
              top_langs.append(("Other", other_bytes))

          labels = [lang for lang, _ in top_langs]
          sizes = [size for _, size in top_langs]

          # ---------- نمودار دایره‌ای ----------
          plt.style.use('dark_background')
          colors = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2']
          plt.figure(figsize=(6,6))
          plt.pie([s/sum(sizes)*100 for s in sizes], labels=labels,
                  autopct='%1.1f%%', startangle=140, colors=colors[:len(labels)])
          plt.title(f"{USERNAME} Languages Usage", color="white")
          plt.savefig("lang_chart.svg", format="svg", facecolor='#0d1117', bbox_inches='tight')
          plt.close()
          EOF

      - name: Commit Cards
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          rm -f lang_chart.svg
          git add github_stats.svg lang_chart.svg
          git commit -m "Update GitHub Stats Cards" || echo "No changes"
          git push --force
