name: Generate GitHub Stats Cards
permissions:
  contents: write
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: Install dependencies
        run: pip install requests matplotlib cairosvg

      - name: Generate Stats Cards
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          python << 'EOF'
          import requests, os
          from collections import defaultdict
          import matplotlib.pyplot as plt
          import cairosvg

          USERNAME = "arminkhorami"
          TOKEN = os.environ["GH_TOKEN"]
          headers = {"Authorization": f"token {TOKEN}"}

          # ---------- Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ Ø¯Ø§Ø¯Ù‡ ----------
          repos_url = "https://api.github.com/user/repos?per_page=100&type=all"
          language_totals = defaultdict(int)
          total_repos = 0
          total_stars = 0

          while repos_url:
              r = requests.get(repos_url, headers=headers)
              repos = r.json()
              total_repos += len(repos)
              for repo in repos:
                  total_stars += repo.get("stargazers_count", 0)
                  langs = requests.get(repo["languages_url"], headers=headers).json()
                  for lang, size in langs.items():
                      language_totals[lang] += size
              repos_url = r.links.get("next", {}).get("url")

          # ---------- Top 6 Ø²Ø¨Ø§Ù† + Other ----------
          sorted_langs = sorted(language_totals.items(), key=lambda x: x[1], reverse=True)
          top_langs = sorted_langs[:6]
          other_bytes = sum(size for _, size in sorted_langs[6:])
          if other_bytes > 0:
              top_langs.append(("Other", other_bytes))

          labels = [lang for lang, _ in top_langs]
          sizes = [size for _, size in top_langs]

          # ---------- Ø¬Ø¯ÙˆÙ„ Markdown ----------
          md = f"## ðŸ§  GitHub Stats for {USERNAME}\n\n"
          md += f"- Total Repos: {total_repos}\n"
          md += f"- Total Stars: {total_stars}\n\n"
          md += "| Language | Usage |\n|----------|-------|\n"
          total_bytes = sum(sizes)
          for label, size in zip(labels, sizes):
              md += f"| {label} | {size/total_bytes*100:.2f}% |\n"

          with open("LANG_STATS.md", "w") as f:
              f.write(md)

          # ---------- Pie Chart ----------
          plt.style.use('dark_background')
          colors = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2']
          plt.figure(figsize=(6,6))
          plt.pie([s/total_bytes*100 for s in sizes], labels=labels,
                  autopct='%1.1f%%', startangle=140, colors=colors[:len(labels)])
          plt.title(f"{USERNAME} Languages Usage", color="white")
          plt.savefig("lang_chart.svg", format="svg", facecolor='#0d1117', bbox_inches='tight')
          plt.close()
          EOF

      - name: Commit Cards
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          rm -f lang_chart.svg  
          git add LANG_STATS.md lang_chart.svg
          git commit -m "Update GitHub Stats Cards" || echo "No changes"
          git push --force
          - name: Commit Cards
    
    

