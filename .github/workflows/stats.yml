name: GitHub Stats Bar Chart
permissions:
  contents: write
on:
  schedule:
    - cron: "0 0 * * *" # Ø§Ø¬Ø±Ø§ Ù‡Ø± Ø´Ø¨ Ø³Ø§Ø¹Øª Û±Û²
  workflow_dispatch:      # Ù‚Ø§Ø¨Ù„ÛŒØª Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: Install dependencies
        run: pip install requests matplotlib

      - name: Generate Stats Chart
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          python << 'EOF'
          import requests
          import os
          import matplotlib.pyplot as plt
          from collections import defaultdict

          USERNAME = "arminkhorami"
          TOKEN = os.environ.get("GH_TOKEN")
          
          if not TOKEN:
              raise Exception("GH_TOKEN is missing!")

          headers = {"Authorization": f"token {TOKEN}"}

          # ---------- 1. Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ----------
          repos_url = "https://api.github.com/user/repos?per_page=100&type=all"
          language_totals = defaultdict(int)
          
          print("Fetching repositories...")
          while repos_url:
              try:
                  r = requests.get(repos_url, headers=headers)
                  if r.status_code != 200: break
                  repos = r.json()
                  
                  for repo in repos:
                      if repo.get("fork"): continue # Ø§Ú¯Ø± Ù†Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø±ÛŒÙ¾ÙˆÙ‡Ø§ÛŒ ÙÙˆØ±Ú© Ø´Ø¯Ù‡ Ø­Ø³Ø§Ø¨ Ø´ÙˆÙ†Ø¯
                      
                      lang_url = repo.get("languages_url")
                      if lang_url:
                          lang_data = requests.get(lang_url, headers=headers).json()
                          for lang, size in lang_data.items():
                              language_totals[lang] += size
                              
                  repos_url = r.links.get("next", {}).get("url")
              except:
                  break

          # ---------- 2. Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (Top 5 + Other) ----------
          # Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ù†Ø²ÙˆÙ„ÛŒ
          sorted_langs = sorted(language_totals.items(), key=lambda x: x[1], reverse=True)
          
          # ÙÙ‚Ø· 5 Ø²Ø¨Ø§Ù† Ø§ÙˆÙ„ Ø±Ø§ Ù†Ú¯Ù‡ Ø¯Ø§Ø±ØŒ Ø¨Ù‚ÛŒÙ‡ Ø±Ø§ Other Ú©Ù†
          limit = 5
          top_langs = sorted_langs[:limit]
          other_bytes = sum(size for _, size in sorted_langs[limit:])
          if other_bytes > 0:
              top_langs.append(("Other", other_bytes))

          # Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø± (Ù…Ø¹Ú©ÙˆØ³ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø²Ø¨Ø§Ù† Ù…Ø­Ø¨ÙˆØ¨ Ø¨Ø§Ù„Ø§ Ø¨Ø§Ø´Ø¯)
          top_langs.reverse() 
          labels = [lang for lang, _ in top_langs]
          sizes = [size for _, size in top_langs]
          total_bytes = sum(sizes) if sum(sizes) > 0 else 1
          percentages = [s/total_bytes*100 for s in sizes]

          # ---------- 3. Ø±Ø³Ù… Ù†Ù…ÙˆØ¯Ø§Ø± Ù…ÛŒÙ„Ù‡â€ŒØ§ÛŒ (Bar Chart) ----------
          # ØªÙ†Ø¸ÛŒÙ… Ø±Ù†Ú¯â€ŒÙ‡Ø§ Ùˆ Ø§Ø³ØªØ§ÛŒÙ„
          bg_color = '#0d1117' # Ø±Ù†Ú¯ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø¯Ø§Ø±Ú© Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨
          text_color = '#c9d1d9' # Ø±Ù†Ú¯ Ù…ØªÙ† Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨
          bar_colors = ['#8b949e', '#58a6ff', '#3fb950', '#d29922', '#f85149', '#a371f7'] # Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ÛŒ
          
          # Ø³Ø§ÛŒØ² Ù…Ø³ØªØ·ÛŒÙ„ÛŒ (Ø¹Ø±Ø¶ 10ØŒ Ø§Ø±ØªÙØ§Ø¹ 4)
          fig, ax = plt.subplots(figsize=(10, 4))
          fig.patch.set_facecolor(bg_color)
          ax.set_facecolor(bg_color)

          # Ø±Ø³Ù… Ù…ÛŒÙ„Ù‡â€ŒÙ‡Ø§
          bars = ax.barh(labels, percentages, color=bar_colors[:len(labels)], height=0.6)

          # Ø­Ø°Ù Ø®Ø·ÙˆØ· Ø¯ÙˆØ± Ù†Ù…ÙˆØ¯Ø§Ø± (Border)
          for spine in ax.spines.values():
              spine.set_visible(False)

          # ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø­ÙˆØ±Ù‡Ø§
          ax.xaxis.set_visible(False) # Ø­Ø°Ù Ø§Ø¹Ø¯Ø§Ø¯ Ù¾Ø§ÛŒÛŒÙ†
          ax.tick_params(axis='y', colors=text_color, labelsize=12, length=0) # ØªÙ†Ø¸ÛŒÙ… ÙÙˆÙ†Øª Ù„ÛŒØ¨Ù„â€ŒÙ‡Ø§

          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø±ØµØ¯ Ø¬Ù„ÙˆÛŒ Ù‡Ø± Ù…ÛŒÙ„Ù‡
          for bar, percent in zip(bars, percentages):
              width = bar.get_width()
              label_x_pos = width + 1  # Ú©Ù…ÛŒ Ø¬Ù„ÙˆØªØ± Ø§Ø² Ù…ÛŒÙ„Ù‡
              ax.text(label_x_pos, bar.get_y() + bar.get_height()/2, f'{percent:.1f}%', 
                      va='center', color=text_color, fontweight='bold')

          plt.title(f"Most Used Languages by {USERNAME}", color=text_color, pad=20, fontsize=14)
          plt.tight_layout()

          # Ø°Ø®ÛŒØ±Ù‡ ÙØ§ÛŒÙ„ SVG
          plt.savefig("lang_chart.svg", format="svg", facecolor=bg_color, bbox_inches='tight')
          print("Chart generated successfully.")
          EOF

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add lang_chart.svg
          git commit -m "Update Stats Chart ğŸ“Š" || echo "No changes"
          git push
