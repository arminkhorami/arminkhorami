name: Update GitHub Stats
permissions:
  contents: write
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: Install dependencies
        run: pip install requests matplotlib

      - name: Generate Stats + Pie Chart
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          python << 'EOF'
          # --- Ú©Ø¯ Python Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Top6 + Other + Dark Pie Chart ---
          import requests, os, matplotlib.pyplot as plt
          from collections import defaultdict

          USERNAME = "arminkhorami"
          TOKEN = os.environ["GH_TOKEN"]
          headers = {"Authorization": f"token {TOKEN}"}

          repos_url = "https://api.github.com/user/repos?per_page=100&type=all"
          language_totals = defaultdict(int)

          while repos_url:
              r = requests.get(repos_url, headers=headers)
              repos = r.json()
              for repo in repos:
                  langs = requests.get(repo["languages_url"], headers=headers).json()
                  for lang, size in langs.items():
                      language_totals[lang] += size
              repos_url = r.links.get("next", {}).get("url")

          sorted_langs = sorted(language_totals.items(), key=lambda x: x[1], reverse=True)
          total_bytes = sum(language_totals.values())

          top_langs = sorted_langs[:6]
          other_bytes = sum(size for _, size in sorted_langs[6:])
          if other_bytes > 0:
              top_langs.append(("Other", other_bytes))

          labels = [lang for lang, _ in top_langs]
          sizes = [size / total_bytes * 100 for _, size in top_langs]

          md = "## ðŸ§  Total Coding Activity (All Repos)\n\n"
          md += "| Language | Usage |\n|----------|-------|\n"
          for label, percent in zip(labels, sizes):
              md += f"| {label} | {percent:.2f}% |\n"
          with open("LANG_STATS.md", "w") as f:
              f.write(md)

          plt.style.use('dark_background')
          colors = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2']
          plt.figure(figsize=(6,6))
          plt.pie(sizes, labels=labels, autopct='%1.1f%%', startangle=140, colors=colors[:len(labels)])
          plt.title("Languages Usage (All Repositories)", color="white")
          plt.savefig("lang_chart.svg", format="svg", facecolor='#0d1117', bbox_inches='tight')
          plt.close()
          EOF

      - name: Commit results
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add LANG_STATS.md lang_chart.svg
          git commit -m "Update GitHub language stats" || echo "No changes"
          git pull --rebase
          git push
